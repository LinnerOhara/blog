(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{574:function(v,_,e){"use strict";e.r(_);var o=e(13),t=Object(o.a)({},(function(){var v=this,_=v.$createElement,e=v._self._c||_;return e("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"title"},[v._v("介绍")]),e("ol",[e("li",[v._v("​网页开发渲染线程和脚本线程是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，而在"),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/#%E5%B0%8F%E7%A8%8B%E5%BA%8F%E4%B8%8E%E6%99%AE%E9%80%9A%E7%BD%91%E9%A1%B5%E5%BC%80%E5%8F%91%E7%9A%84%E5%8C%BA%E5%88%AB",target:"_blank",rel:"noopener noreferrer"}},[v._v("小程序"),e("OutboundLink")],1),v._v("中，二者是分开的，分别运行在不同的线程中。"),e("br")]),v._v(" "),e("li",[v._v("小程序的逻辑层和渲染层是分开的，逻辑层运行在 JSCore 中，并没有一个完整浏览器对象，因而缺少相关的DOM API和BOM API。同时 JSCore 的环境同 NodeJS 环境也是不尽相同，所以一些 NPM 的包在小程序中也是无法运行的。"),e("br")]),v._v(" "),e("li",[v._v("小程序开发过程中需要面对的是两大操作系统 iOS 和 Android 的微信客户端，以及用于辅助开发的小程序开发者工具。")])])]),v._v(" "),e("p",[e("strong",[v._v("小程序的运行环境")])]),v._v(" "),e("table",[e("thead",[e("tr",[e("th",[v._v("运行环境")]),v._v(" "),e("th",[v._v("逻辑层")]),v._v(" "),e("th",[v._v("渲染层")])])]),v._v(" "),e("tbody",[e("tr",[e("td",[v._v("ios")]),v._v(" "),e("td",[v._v("javaScriptCore")]),v._v(" "),e("td",[v._v("WKWebView")])]),v._v(" "),e("tr",[e("td",[v._v("安卓")]),v._v(" "),e("td",[v._v("V8")]),v._v(" "),e("td",[v._v("chromium定制内核")])]),v._v(" "),e("tr",[e("td",[v._v("小程序开发工具")]),v._v(" "),e("td",[v._v("NWJS")]),v._v(" "),e("td",[v._v("Chrome WebView")])])])]),v._v(" "),e("p",[e("strong",[v._v("渲染层和逻辑层")])]),v._v(" "),e("p",[v._v("小程序的渲染层和逻辑层分别由2个线程管理：渲染层的界面使用了WebView 进行渲染；逻辑层采用JsCore线程运行JS脚本，整个小程序"),e("code",[v._v("只有一个APP实例")]),v._v("，切换小程序页面时，小程序逻辑层的JS脚本运行上下文依旧在"),e("code",[v._v("同一个JsCore线程")]),v._v("中。一个小程序存在多个界面，所以"),e("code",[v._v("渲染层存在多个WebView线程")]),v._v("，这两个线程的通信会经由微信客户端（下文中也会采用Native来代指微信客户端）做中转，逻辑层发送网络请求也经由Native转发，小程序的通信模型下图所示。")]),v._v(" "),e("p",[v._v("与此同时，我们要特别留意一点，所有页面的脚本逻辑都跑在同一个JsCore线程，页面使用setTimeout或者setInterval的定时器，然后跳转到其他页面时，这些定时器并没有被清除，需要开发者自己在页面离开的时候进行"),e("code",[v._v("清理")]),v._v("。")]),v._v(" "),e("p",[e("img",{attrs:{src:"https://raw.githubusercontent.com/LinnerOhara/blog/main/img/4-1.ad156d1c.png",alt:"渲染层和逻辑层"}})]),v._v(" "),e("p",[e("strong",[v._v("程序的生命周期")])]),v._v(" "),e("p",[v._v("初次进入小程序的时候，微信客户端初始化好宿主环境，同时从网络下载或本地缓存中拿到小程序的代码包，把它注入到宿主环境,初始化完成后，微信客户端就会给"),e("code",[v._v("App实例")]),v._v("派发"),e("code",[v._v("onLaunch")]),v._v("事件，App构造器参数所定义的onLaunch方法会被调用。")]),v._v(" "),e("p",[v._v("进入小程序之后，用户可以点击右上角的关闭，或者按手机设备的Home键离开小程序，此时小程序并没有被直接销毁，我们把这种情况称为"),e("code",[v._v("“小程序进入后台状态”")]),v._v("，App构造器参数所定义的"),e("code",[v._v("onHide")]),v._v("方法会被调用。")]),v._v(" "),e("p",[v._v("当再次回到微信或者再次打开小程序时，微信客户端会把“后台”的小程序唤醒，我们把这种情况称为"),e("code",[v._v("“小程序进入前台状态”")]),v._v("，App构造器参数所定义的"),e("code",[v._v("onShow")]),v._v("方法会被调用。")]),v._v(" "),e("p",[e("code",[v._v("onLoad早于 onShow。")])]),v._v(" "),e("p",[e("strong",[v._v("页面的生命周期")])]),v._v(" "),e("p",[v._v("页面初次加载的时候，微信客户端就会给Page实例派发onLoad事件，Page构造器参数所定义的onLoad方法会被调用，"),e("code",[v._v("onLoad在页面没被销毁之前只会触发1次")]),v._v("，在onLoad的回调中，可以获取当前页面所调用的打开参数option")]),v._v(" "),e("p",[v._v("页面显示之后，Page构造器参数所定义的"),e("code",[v._v("onShow")]),v._v("方法会被调用，一般从别的页面返回到当前页面时，当前页的onShow方法都会被调用。")]),v._v(" "),e("p",[v._v("在页面初次渲染完成时，Page构造器参数所定义的onReady方法会被调用，"),e("code",[v._v("onReady在页面没被销毁前只会触发1次")]),v._v("，onReady触发时，表示页面已经准备妥当，在逻辑层就可以和视图层进行交互了。")]),v._v(" "),e("p",[e("code",[v._v("以上三个事件触发的时机是onLoad早于 onShow，onShow早于onReady。")])]),v._v(" "),e("p",[v._v("页面不可见时，Page构造器参数所定义的onHide方法会被调用，这种情况会在使用"),e("code",[v._v("wx.navigateTo")]),v._v("切换到其他页面、"),e("code",[v._v("底部tab切换")]),v._v("时触发。")]),v._v(" "),e("p",[v._v("当前页面使用"),e("code",[v._v("wx.redirectTo")]),v._v("或"),e("code",[v._v("wx.navigateBack")]),v._v("返回到其他页时，当前页面会被微信客户端"),e("code",[v._v("销毁回收")]),v._v("，此时Page构造器参数所定义的"),e("code",[v._v("onUnload")]),v._v("方法会被调用。")]),v._v(" "),e("p",[e("strong",[v._v("页面跳转和路由")])]),v._v(" "),e("p",[v._v("一个小程序拥有多个页面，我们可以通过"),e("code",[v._v("wx.navigateTo")]),v._v(" 推入一个新的页面，我们称这种页面层级叫页面栈。页面栈最大层级为10层，到达10层之后无法打开新的页面。")]),v._v(" "),e("p",[v._v("使用"),e("code",[v._v("wx.navigateBack")]),v._v("可以退出当前页面栈的最顶上页面。")]),v._v(" "),e("p",[v._v("使用"),e("code",[v._v("wx.redirectTo({ url: 'pageE' })")]),v._v(" 是替换当前页变成pageE。")]),v._v(" "),e("p",[v._v("一般为了提升用户体验，我们应善用"),e("code",[v._v("wx.navigateBack")]),v._v("和"),e("code",[v._v("wx.redirectTo")]),v._v("把页面栈控制在5层内。")]),v._v(" "),e("p",[v._v("我们也可以使用"),e("code",[v._v("wx.switchTab")]),v._v("，此时原本的页面栈会清空（除了声明为Tabbar页以外页面会被销毁）。")]),v._v(" "),e("p",[v._v("还可以使用"),e("code",[v._v("wx. reLaunch")]),v._v(" 重启小程序，此时页面栈会清空。")]),v._v(" "),e("p",[v._v("详细页面路由跳转触发方式及页面生命周期函数关系详见"),e("a",{attrs:{href:"https://developers.weixin.qq.com/ebook?action=get_post_info&docid=0004eec99acc808b00861a5bd5280a",target:"_blank",rel:"noopener noreferrer"}},[v._v("官方教程"),e("OutboundLink")],1),v._v("。")]),v._v(" "),e("p",[e("strong",[v._v("初始渲染缓存")])]),v._v(" "),e("div",{staticClass:"custom-block theorem"},[e("p",{staticClass:"title"},[v._v("小程序页面的初始化分为两个部分")]),e("ul",[e("li",[v._v("逻辑层初始化：载入必需的小程序代码、初始化页面 this 对象（也包括它涉及到的所有自定义组件的 this 对象）、将相关数据发送给视图层。")]),v._v(" "),e("li",[v._v("视图层初始化：载入必需的小程序代码，然后等待逻辑层初始化完毕并接收逻辑层发送的数据，最后渲染页面。")])]),v._v(" "),e("p",[v._v("在启动页面时，尤其是小程序冷启动、进入第一个页面时，逻辑层初始化的时间较长。启用初始渲染缓存，可以使视图层不需要等待逻辑层初始化完毕，而直接提前将页面初始 data 的渲染结果展示给用户，这可以使得页面对用户可见的时间大大提前。它的工作原理如下：")]),v._v(" "),e("ul",[e("li",[v._v("在小程序页面第一次被打开后，将页面初始数据渲染结果记录下来，写入一个持久化的缓存区域（缓存可长时间保留，但可能因为小程序更新、基础库更新、储存空间回收等原因被清除）；")]),v._v(" "),e("li",[v._v("在这个页面被第二次打开时，检查缓存中是否还存有这个页面上一次初始数据的渲染结果，如果有，就直接将渲染结果展示出来；")]),v._v(" "),e("li",[v._v("如果展示了缓存中的渲染结果，这个页面暂时还不能响应用户事件，等到逻辑层初始化完毕后才能响应用户事件。")])]),v._v(" "),e("p",[v._v("利用初始渲染缓存，可以：")]),v._v(" "),e("ul",[e("li",[v._v("快速展示出页面中永远不会变的部分，如导航栏；")]),v._v(" "),e("li",[v._v("预先展示一个骨架页，提升用户体验；")]),v._v(" "),e("li",[v._v("展示自定义的加载提示；")]),v._v(" "),e("li",[v._v("提前展示广告，等等。")])]),v._v(" "),e("div",{staticClass:"custom-block right"},[e("p",[v._v("来自 "),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/view/initial-rendering-cache.html",target:"_blank",rel:"noopener noreferrer"}},[v._v("微信官方文档"),e("OutboundLink")],1)])])]),e("p",[e("strong",[v._v("小程序启动流程（详见"),e("a",{attrs:{href:"https://developers.weixin.qq.com/miniprogram/dev/framework/performance/tips/start_process.html",target:"_blank",rel:"noopener noreferrer"}},[v._v("小程序启动流程"),e("OutboundLink")],1),v._v("）")])]),v._v(" "),e("p",[v._v("小程序启动的各流程不是串行的，会尽可能的并行。计算总启动耗时不能简单的分阶段加和。")]),v._v(" "),e("blockquote",[e("p",[v._v("大致流程为：")]),v._v(" "),e("p",[v._v("视图层：Native 代码包下载及校验—>前端框架初始化—>插件/扩展库注入(若有)—>视图层开发者代码注入(公共+页面代码)—>页面渲染—>渲染完成")]),v._v(" "),e("p",[v._v("逻辑层：Native 代码包下载及校验—>前端框架初始化—>插件/扩展库注入(若有)—>逻辑层开发者代码注入(App.onLaunch、App.onShow)—>页面初始化—>页面渲染—>页面onLoad—>页面onShow—>渲染完成—>页面onReady")])]),v._v(" "),e("p",[v._v("tips：由于小程序启动会尽可能的并行，小程序的APP.onLaunch 并不会阻塞整个小程序的渲染，所以无法在页面的Page.onLoad获取到 APP.onLaunch 的异步结果。")])])}),[],!1,null,null,null);_.default=t.exports}}]);
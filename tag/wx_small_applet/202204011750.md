---
title: 微信小程序渲染过程
date: 2022-3-30
tags:
 - 微信小程序
categories: 
 - 微信小程序
---

::: tip 介绍
1. ​网页开发渲染线程和脚本线程是互斥的，这也是为什么长时间的脚本运行可能会导致页面失去响应，而在[小程序](https://developers.weixin.qq.com/miniprogram/dev/framework/quickstart/#小程序与普通网页开发的区别)中，二者是分开的，分别运行在不同的线程中。<br>
2. 小程序的逻辑层和渲染层是分开的，逻辑层运行在 JSCore 中，并没有一个完整浏览器对象，因而缺少相关的DOM API和BOM API。同时 JSCore 的环境同 NodeJS 环境也是不尽相同，所以一些 NPM 的包在小程序中也是无法运行的。<br>
3. 小程序开发过程中需要面对的是两大操作系统 iOS 和 Android 的微信客户端，以及用于辅助开发的小程序开发者工具。
:::

**小程序的运行环境**
|  运行环境 | 逻辑层 | 渲染层 |
|  ----  | ----  | --- |
| ios  | javaScriptCore | WKWebView |
| 安卓  | V8 | chromium定制内核 |
| 小程序开发工具  | NWJS | Chrome WebView |

**渲染层和逻辑层**
小程序的渲染层和逻辑层分别由2个线程管理：渲染层的界面使用了WebView 进行渲染；逻辑层采用JsCore线程运行JS脚本，整个小程序`只有一个APP实例`，切换小程序页面时，小程序逻辑层的JS脚本运行上下文依旧在`同一个JsCore线程`中。一个小程序存在多个界面，所以`渲染层存在多个WebView线程`，这两个线程的通信会经由微信客户端（下文中也会采用Native来代指微信客户端）做中转，逻辑层发送网络请求也经由Native转发，小程序的通信模型下图所示。

与此同时，我们要特别留意一点，所有页面的脚本逻辑都跑在同一个JsCore线程，页面使用setTimeout或者setInterval的定时器，然后跳转到其他页面时，这些定时器并没有被清除，需要开发者自己在页面离开的时候进行`清理`。

![渲染层和逻辑层](https://raw.githubusercontent.com/LinnerOhara/blog/main/img/4-1.ad156d1c.png)

**程序的生命周期**
初次进入小程序的时候，微信客户端初始化好宿主环境，同时从网络下载或本地缓存中拿到小程序的代码包，把它注入到宿主环境,初始化完成后，微信客户端就会给`App实例`派发`onLaunch`事件，App构造器参数所定义的onLaunch方法会被调用。

进入小程序之后，用户可以点击右上角的关闭，或者按手机设备的Home键离开小程序，此时小程序并没有被直接销毁，我们把这种情况称为`“小程序进入后台状态”`，App构造器参数所定义的`onHide`方法会被调用。

当再次回到微信或者再次打开小程序时，微信客户端会把“后台”的小程序唤醒，我们把这种情况称为`“小程序进入前台状态”`，App构造器参数所定义的`onShow`方法会被调用。

`onLoad早于 onShow。`

**页面的生命周期**

页面初次加载的时候，微信客户端就会给Page实例派发onLoad事件，Page构造器参数所定义的onLoad方法会被调用，`onLoad在页面没被销毁之前只会触发1次`，在onLoad的回调中，可以获取当前页面所调用的打开参数option

页面显示之后，Page构造器参数所定义的`onShow`方法会被调用，一般从别的页面返回到当前页面时，当前页的onShow方法都会被调用。

在页面初次渲染完成时，Page构造器参数所定义的onReady方法会被调用，`onReady在页面没被销毁前只会触发1次`，onReady触发时，表示页面已经准备妥当，在逻辑层就可以和视图层进行交互了。

`以上三个事件触发的时机是onLoad早于 onShow，onShow早于onReady。`

页面不可见时，Page构造器参数所定义的onHide方法会被调用，这种情况会在使用`wx.navigateTo`切换到其他页面、`底部tab切换`时触发。

当前页面使用`wx.redirectTo`或`wx.navigateBack`返回到其他页时，当前页面会被微信客户端`销毁回收`，此时Page构造器参数所定义的`onUnload`方法会被调用。

小程序的APP.onLaunch 并不会阻塞整个小程序的渲染，所以无法在页面的Page.onLoad获取到 APP.onLaunch 的异步结果
